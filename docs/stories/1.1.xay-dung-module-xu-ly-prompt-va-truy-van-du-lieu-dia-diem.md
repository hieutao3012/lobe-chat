# Story 1.1: Xây dựng module xử lý prompt và truy vấn dữ liệu địa điểm

## Status

Completed

## Story

**As a** người dùng,
**I want** nhập yêu cầu bằng ngôn ngữ tự nhiên và nhận được danh sách địa điểm phù hợp,
**so that** tôi có thể tìm kiếm địa điểm một cách nhanh chóng và chính xác chỉ bằng việc nói ra ý muốn của mình.

## Acceptance Criteria

1. Module NLP cơ bản có thể phân tích và trích xuất ít nhất 3 loại entity từ prompt người dùng (danh mục, khu vực, giá cả)
2. Hệ thống truy vấn có thể xử lý file `places.json` 51MB và trả về kết quả trong vòng 3 giây
3. Khi prompt không rõ ràng, hệ thống có thể yêu cầu người dùng làm rõ thông tin
4. Hệ thống có cơ chế fallback khi không tìm thấy địa điểm phù hợp

## Tasks / Subtasks

- [x] Task 1 (AC: 1)
  - [x] Subtask 1.1: Nghiên cứu và lựa chọn thư viện NLP phù hợp cho việc phân tích prompt
  - [x] Subtask 1.2: Xây dựng module phân tích prompt để trích xuất entity (danh mục, khu vực, giá cả)
  - [x] Subtask 1.3: Tạo unit test cho module phân tích prompt
- [x] Task 2 (AC: 2)
  - [x] Subtask 2.1: Thiết kế cấu trúc dữ liệu cho việc lưu trữ thông tin địa điểm từ `places.json`
  - [x] Subtask 2.2: Xây dựng module truy vấn dữ liệu địa điểm với hiệu suất tối ưu
  - [x] Subtask 2.3: Tạo unit test cho module truy vấn dữ liệu
- [x] Task 3 (AC: 3)
  - [x] Subtask 3.1: Xây dựng logic để yêu cầu người dùng làm rõ thông tin khi prompt mơ hồ
  - [x] Subtask 3.2: Tạo unit test cho tính năng yêu cầu làm rõ thông tin
- [x] Task 4 (AC: 4)
  - [x] Subtask 4.1: Xây dựng cơ chế fallback khi không tìm thấy địa điểm phù hợp
  - [x] Subtask 4.2: Tạo unit test cho cơ chế fallback

## Dev Notes

### Data Models

Dựa trên cấu trúc `places.json` được mô tả trong tài liệu, chúng ta sẽ có các model chính sau:

- `Place`: Đại diện cho một địa điểm với các thuộc tính như `id`, `name`, `categoryItems`, `address`, `priceRange`, `rating`, `openTimes`.
- `Address`: Bao gồm `street`, `district`, `city`.
- `SearchCriteria`: Chứa các tiêu chí tìm kiếm được trích xuất từ prompt người dùng như `categories`, `area`, `priceRange`.

[Source: architecture/data-models.md]

### API Specifications

Module sẽ không trực tiếp tạo API endpoint, nhưng sẽ được sử dụng bởi các component trong ứng dụng. Tuy nhiên, ta có thể tham khảo cấu trúc API được đề xuất trong tài liệu:

- `GET /places`: Để tìm kiếm địa điểm dựa trên các tiêu chí
- Các tham số query bao gồm `query`, `category`, `area`, `priceRange`, `limit`

[Source: architecture/api-specification.md]

### Component Specifications

Sẽ cần tích hợp với các component sau trong LobeChat:

- Chat Interface Component: Để nhận prompt từ người dùng
- Place Search Component: Để xử lý logic tìm kiếm địa điểm

[Source: architecture/components.md]

### File Locations

Theo cấu trúc dự án được mô tả, các file code mới nên được đặt trong:

- `src/features/place-search/`: Chứa logic tìm kiếm địa điểm
- `src/services/`: Chứa các service liên quan đến xử lý dữ liệu
- `src/utils/`: Chứa các hàm tiện ích cho việc xử lý NLP

[Source: architecture/unified-project-structure.md]

### Testing Requirements

- Viết unit test cho tất cả các function xử lý chính
- Sử dụng Jest/Vitest cho testing như được mô tả trong tech stack
- Coverage test cho các trường hợp edge case và fallback

[Source: architecture/testing-strategy.md]

### Technical Constraints

- Phải đảm bảo hiệu suất xử lý file `places.json` 51MB trong vòng 3 giây
- Cần tối ưu bộ nhớ khi xử lý file JSON lớn
- Phải tương thích với các thư viện NLP được liệt kê trong tech stack

[Source: architecture/tech-stack.md]

### Implementation Details

Đã hoàn thành việc xây dựng các module sau:

1. **NLP Processor** (`src/services/placeSearch/nlpProcessor.ts`):
   - Xây dựng module phân tích prompt để trích xuất entity (danh mục, khu vực, giá cả)
   - Sử dụng thư viện `compromise` để xử lý ngôn ngữ tự nhiên
   - Tạo unit test cho module phân tích prompt

2. **Place Data Service** (`src/services/placeSearch/placeService.ts`):
   - Thiết kế cấu trúc dữ liệu cho việc lưu trữ thông tin địa điểm từ `places.json`
   - Xây dựng module truy vấn dữ liệu địa điểm với hiệu suất tối ưu
   - Tạo unit test cho module truy vấn dữ liệu

3. **User Prompt Processor** (`src/services/placeSearch/userPromptProcessor.ts`):
   - Xây dựng logic để yêu cầu người dùng làm rõ thông tin khi prompt mơ hồ
   - Xây dựng cơ chế fallback khi không tìm thấy địa điểm phù hợp
   - Tạo unit test cho các tính năng này

4. **Advanced Search Service** (`src/services/placeSearch/advancedSearchService.ts`):
   - Xây dựng service tìm kiếm nâng cao với nhiều tiêu chí
   - Tạo unit test cho service tìm kiếm nâng cao

[Source: src/services/placeSearch/]

## Testing

### Testing Standards

- Test file location: Các file test sẽ được đặt cùng thư mục với file source code, với tên có suffix `.test.ts` hoặc `.spec.ts`
- Test standards: Tuân theo các pattern testing được sử dụng trong LobeChat
- Testing frameworks: Sử dụng Jest/Vitest như đã được cấu hình trong dự án
- Specific testing requirements: 
  - Mock dữ liệu `places.json` để test hiệu suất
  - Test với các prompt mẫu có độ phức tạp khác nhau
  - Test cơ chế fallback với các trường hợp không tìm thấy kết quả
  - Test hiệu suất xử lý với dữ liệu lớn

[Source: architecture/testing-strategy.md]

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-28 | 1.0 | Initial story draft | Bob (Scrum Master) |
| 2025-08-28 | 1.1 | Completed implementation of NLP processor and place search modules | James (Developer) |